/*
 * Ext JS Library 3.0.0
 * Copyright(c) 2006-2009 Ext JS, LLC
 * licensing@extjs.com
 * http://www.extjs.com/license
 * 
 * Modifications by Mykhail Stadnik <http://mikhailstadnik.com>:
 *  - Nesting grids support added
 */
Ext.ns("Ext.ux.grid");Ext.ux.grid.RowExpander=Ext.extend(Ext.util.Observable,{expandOnEnter:true,expandOnDblClick:true,header:"",width:20,sortable:false,fixed:true,menuDisabled:true,dataIndex:"",id:"expander",lazyRender:true,enableCaching:true,actAsTree:false,treeLeafProperty:"is_leaf",appendRowClass:true,constructor:function(a){if(!a.id){a.id=Ext.id()}Ext.apply(this,a);var b=".x-"+this.id+"-grid3-row-collapsed .x-grid3-row-expander { background-position:0 0; }.x-"+this.id+"-grid3-row-expanded .x-grid3-row-expander { background-position:-25px 0; }.x-"+this.id+"-grid3-row-collapsed .x-grid3-row-body { display:none !important; }.x-"+this.id+"-grid3-row-expanded .x-grid3-row-body { display:block !important; }.x-grid-expander-leaf .x-grid3-row-expander { background: none; }";Ext.util.CSS.createStyleSheet(b,Ext.id());this.expanderClass="x-grid3-row-expander";this.rowExpandedClass="x-"+this.id+"-grid3-row-expanded";this.rowCollapsedClass="x-"+this.id+"-grid3-row-collapsed";this.leafClass="x-grid-expander-leaf";this.addEvents({beforeexpand:true,expand:true,beforecollapse:true,collapse:true});Ext.ux.grid.RowExpander.superclass.constructor.call(this);if(this.tpl){if(typeof this.tpl=="string"){this.tpl=new Ext.Template(this.tpl)}this.tpl.compile()}this.state={};this.bodyContent={}},getRowClass:function(b,f,e,d){e.cols=e.cols-1;var c=this.bodyContent[b.id];if(!c&&!this.lazyRender){c=this.getBodyContent(b,f)}if(c){e.body=c}var a=this.state[b.id]?this.rowExpandedClass:this.rowCollapsedClass;if(this.actAsTree&&b.get(this.treeLeafProperty)){a=this.leafClass}return a},init:function(b){this.grid=b;var a=b.getView();a.getRowClass=this.getRowClass.createDelegate(this);a.enableRowBody=true;b.on("render",this.onRender,this);b.on("destroy",this.onDestroy,this);a.on("beforerefresh",this.onBeforeRefresh,this);a.on("refresh",this.onRefresh,this)},onRender:function(){var a=this.grid;var b=a.getView().mainBody;b&&b.on("mousedown",this.onMouseDown,this,{delegate:"."+this.expanderClass});if(this.expandOnEnter){this.keyNav=new Ext.KeyNav(this.grid.getGridEl(),{enter:this.onEnter,scope:this})}if(this.expandOnDblClick){a.on("rowdblclick",this.onRowDblClick,this)}if(this.actAsTree){a.getEl().swallowEvent(["mouseover","mouseout","mousedown","click","dblclick"])}},onBeforeRefresh:function(){var a=this.grid.getEl().select("."+this.rowExpandedClass);a.each(function(b){this.collapseRow(b.dom)},this)},onRefresh:function(){var a=this.grid.getEl().select("."+this.rowExpandedClass);a.each(function(b){Ext.fly(b).replaceClass(this.rowExpandedClass,this.rowCollapsedClass)},this)},onDestroy:function(){this.keyNav.disable();delete this.keyNav;var a=this.grid.getView().mainBody;a&&a.un("mousedown",this.onMouseDown,this)},onRowDblClick:function(a,b,c){this.toggleRow(b)},onEnter:function(h){var f=this.grid;var j=f.getSelectionModel();var b=j.getSelections();for(var c=0,a=b.length;c<a;c++){var d=f.getStore().indexOf(b[c]);this.toggleRow(d)}},getBodyContent:function(a,b){if(!this.enableCaching){return this.tpl.apply(a.data)}var c=this.bodyContent[a.id];if(!c){c=this.tpl.apply(a.data);this.bodyContent[a.id]=c}return c},onMouseDown:function(b,a){b.stopEvent();var c=b.getTarget(".x-grid3-row");this.toggleRow(c)},renderer:function(b,c,a){c.cellAttr='rowspan="2"';return'<div class="'+this.expanderClass+'">&#160;</div>'},beforeExpand:function(b,a,c){if(this.fireEvent("beforeexpand",this,b,a,c)!==false){if(this.tpl&&this.lazyRender){a.innerHTML=this.getBodyContent(b,c)}return true}else{return false}},toggleRow:function(a){if(typeof a=="number"){a=this.grid.view.getRow(a)}if(Ext.fly(a).hasClass(this.leafClass)){return}this[Ext.fly(a).hasClass(this.rowCollapsedClass)?"expandRow":"collapseRow"](a)},expandRow:function(c){if(typeof c=="number"){c=this.grid.view.getRow(c)}if(Ext.fly(c).hasClass(this.leafClass)){return}var b=this.grid.store.getAt(c.rowIndex);var a=Ext.DomQuery.selectNode("tr:nth(2) div.x-grid3-row-body",c);if(this.beforeExpand(b,a,c.rowIndex)){this.state[b.id]=true;Ext.fly(c).replaceClass(this.rowCollapsedClass,this.rowExpandedClass);this.fireEvent("expand",this,b,a,c.rowIndex)}},destroyNestedGrids:function(g){if(g){if(childGridEl=g.child(".x-grid-panel")){this.destroyNestedGrids(childGridEl)}var d=Ext.getCmp(g.id);if(d&&(d!=this.grid)){if(d instanceof Ext.grid.EditorGridPanel){var a=d.getColumnModel();for(var c=0,f=a.getColumnCount();c<f;c++){for(var e=0,b=d.getStore().getCount();e<b;e++){if(editor=a.getCellEditor(c,e)){editor.destroy()}}}a.destroy()}d.destroy()}}},collapseRow:function(c){if(typeof c=="number"){c=this.grid.view.getRow(c)}if(Ext.fly(c).hasClass(this.leafClass)){return}var b=this.grid.store.getAt(c.rowIndex);var a=Ext.fly(c).child("tr:nth(1) div.x-grid3-row-body",true);if(this.fireEvent("beforecollapse",this,b,a,c.rowIndex)!==false){this.destroyNestedGrids(Ext.get(c).child(".x-grid-panel"));if(b){this.state[b.id]=false}Ext.fly(c).replaceClass(this.rowExpandedClass,this.rowCollapsedClass);this.fireEvent("collapse",this,b,a,c.rowIndex)}}});Ext.preg("rowexpander",Ext.ux.grid.RowExpander);Ext.grid.RowExpander=Ext.ux.grid.RowExpander;Ext.ns("Ext.ux.grid");Ext.ux.grid.GridSummary=function(a){Ext.apply(this,a)};Ext.extend(Ext.ux.grid.GridSummary,Ext.util.Observable,{init:function(b){this.grid=b;this.cm=b.getColumnModel();this.view=b.getView();var a=this.view;a.onLayout=this.onLayout;a.afterMethod("render",this.refreshSummary,this);a.afterMethod("refresh",this.refreshSummary,this);a.afterMethod("syncScroll",this.syncSummaryScroll,this);a.afterMethod("onColumnWidthUpdated",this.doWidth,this);a.afterMethod("onAllColumnWidthsUpdated",this.doAllWidths,this);a.afterMethod("onColumnHiddenUpdated",this.doHidden,this);b.store.on({add:this.refreshSummary,remove:this.refreshSummary,clear:this.refreshSummary,update:this.refreshSummary,scope:this});if(!this.rowTpl){this.rowTpl=new Ext.Template('<div class="x-grid3-summary-row x-grid3-gridsummary-row-offset">','<table class="x-grid3-summary-table" border="0" cellspacing="0" cellpadding="0" style="{tstyle}">',"<tbody><tr>{cells}</tr></tbody>","</table>","</div>");this.rowTpl.disableFormats=true}this.rowTpl.compile();if(!this.cellTpl){this.cellTpl=new Ext.Template('<td class="x-grid3-col x-grid3-cell x-grid3-td-{id} {css}" style="{style}">','<div class="x-grid3-cell-inner x-grid3-col-{id}" unselectable="on" {attr}>{value}</div>',"</td>");this.cellTpl.disableFormats=true}this.cellTpl.compile()},calculate:function(c,l){var e={},h=l.config;for(var f=0,k=h.length;f<k;f++){var b=h[f],g=b.dataIndex;e[g]=0;if(b.summaryType){for(var d=0,m=c.length;d<m;d++){var a=c[d];e[g]=Ext.ux.grid.GridSummary.Calculations[b.summaryType](a.get(g),a,g,e,d)}}}return e},onLayout:function(a,b){if(Ext.type(b)!="number"){return}if(!this.grid.getGridEl().hasClass("x-grid-hide-gridsummary")){this.scroller.setHeight(b-this.summary.getHeight())}},syncSummaryScroll:function(){var a=this.view.scroller.dom;this.view.summaryWrap.dom.scrollLeft=a.scrollLeft;this.view.summaryWrap.dom.scrollLeft=a.scrollLeft},doWidth:function(c,a,b){var d=this.view.summary.dom;d.firstChild.style.width=b;d.firstChild.rows[0].childNodes[c].style.width=a},doAllWidths:function(a,b){var e=this.view.summary.dom,f=a.length;e.firstChild.style.width=b;var d=e.firstChild.rows[0].childNodes;for(var c=0;c<f;c++){d[c].style.width=a[c]}},doHidden:function(b,d,a){var c=this.view.summary.dom,e=d?"none":"";c.firstChild.style.width=a;c.firstChild.rows[0].childNodes[b].style.display=e},renderSummary:function(d,g,l){g=g||this.view.getColumnData();var h=l.config,e=[],m=g.length-1;for(var f=0,j=g.length;f<j;f++){var k=g[f],b=h[f],a={};a.id=k.id;a.style=k.style;a.css=f===0?"x-grid3-cell-first ":(f==m?"x-grid3-cell-last ":"");if(b.summaryType||b.summaryRenderer){a.value=(b.summaryRenderer||k.renderer)(d.data[k.name],a,d)}else{a.value=""}if(a.value===undefined||a.value===""){a.value="&#160;"}e[e.length]=this.cellTpl.apply(a)}return this.rowTpl.apply({tstyle:"width:"+this.view.getTotalWidth()+";",cells:e.join("")})},refreshSummary:function(){var e=this.grid,h=e.store,d=this.view.getColumnData(),a=this.cm,b=h.getRange(),f=this.calculate(b,a),c=this.renderSummary({data:f},d,a);if(!this.view.summaryWrap){this.view.summaryWrap=Ext.DomHelper.insertAfter(this.view.scroller,{tag:"div",cls:"x-grid3-gridsummary-row-inner"},true)}this.view.summary=this.view.summaryWrap.update(c).first()},toggleSummary:function(b){var a=this.grid.getGridEl();if(a){if(b===undefined){b=a.hasClass("x-grid-hide-gridsummary")}a[b?"removeClass":"addClass"]("x-grid-hide-gridsummary");this.view.layout()}},getSummaryNode:function(){return this.view.summary}});Ext.reg("gridsummary",Ext.ux.grid.GridSummary);Ext.ux.grid.GridSummary.Calculations={sum:function(b,a,c,e,d){return e[c]+Ext.num(b,0)},count:function(b,a,c,e,d){return d+1},max:function(b,a,c,e,d){return Math.max(Ext.num(b,0),e[c])},min:function(b,a,c,e,d){return Math.min(Ext.num(b,0),e[c])},average:function(b,a,d,g,f){var c=g[d]+Ext.num(b,0),e=a.store.getCount();return f==e-1?(c/e):c}};